<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cacao Optimizer V5 | Pro Solver & Alerts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root {
            --bg-body: #fbfbfd;
            --bg-card: #ffffff;
            --text-main: #1d1d1f;
            --text-secondary: #86868b;
            --border-color: #f2f2f7;
            --input-bg: #f5f5f7;
        }

        .dark-mode {
            --bg-body: #000000;
            --bg-card: #1c1c1e;
            --text-main: #f5f5f7;
            --text-secondary: #a1a1a6;
            --border-color: #2c2c2e;
            --input-bg: #2c2c2e;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); padding-top: 120px; transition: all 0.3s ease; }
        [dir="rtl"] { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        .apple-nav {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 1300px; height: 80px;
            background: rgba(255, 255, 255, 0.7); backdrop-filter: saturate(180%) blur(20px);
            border-radius: 24px; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.08); z-index: 9999;
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
        }
        .dark-mode .apple-nav {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-group { display: flex; flex-direction: column; align-items: center; min-width: 100px; border-left: 1px solid var(--border-color); padding-left: 15px; }
        [dir="rtl"] .stat-group { border-left: none; border-right: 1px solid var(--border-color); padding-left: 0; padding-right: 15px; }
        .stat-group:first-child { border: none; }
        
        .stat-value { font-size: 18px; font-weight: 800; line-height: 1; margin-top: 4px; }
        .stat-label { font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-marge { font-size: 10px; font-weight: 800; margin-top: 2px; }

        .status-positive { color: #10b981; }
        .status-negative { color: #ef4444; }
        .status-neutral { color: #3b82f6; }

        .card-apple { background: var(--bg-card); border-radius: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); border: 1px solid var(--border-color); }
        .input-apple { background: var(--input-bg); color: var(--text-main); border-radius: 12px; border: none; padding: 10px; font-weight: 700; text-align: center; width: 100%; transition: all 0.2s ease; }
        .input-apple:focus { background: var(--bg-card); outline: 2px solid #0071e3; }
        
        .btn-apple { background: #0071e3; color: white; padding: 10px 22px; border-radius: 980px; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .btn-theme, .btn-lang { background: var(--input-bg); color: var(--text-main); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; font-weight: bold; font-size: 11px; }

        .excel-table th { background: var(--input-bg); color: var(--text-secondary); font-size: 10px; text-transform: uppercase; padding: 12px; border: 1px solid var(--border-color); }
        .excel-table td { border: 1px solid var(--border-color); padding: 10px; font-size: 12px; font-weight: 700; text-align: center; }
        
        .alert-pill { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .alert-warning { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .alert-danger { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }
        .alert-ok { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; }
    </style>
</head>
<body>

    <nav class="apple-nav">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center text-white"><i class="fas fa-leaf"></i></div>
            <div class="hidden md:block">
                <h1 class="text-sm font-black tracking-tight" data-i18n="app-title">CACAO OPTIMIZER</h1>
                <p class="text-[9px] text-gray-400 font-bold uppercase" data-i18n="app-subtitle">Moyennes en Temps Réel</p>
            </div>
        </div>

        <div class="flex items-center gap-2 lg:gap-8">
            <div class="stat-group">
                <span class="stat-label">H-MIX</span>
                <span id="nav-h" class="stat-value">0.00%</span>
                <span id="marge-h" class="stat-marge">--</span>
            </div>
            <div class="stat-group">
                <span class="stat-label">G-MOY</span>
                <span id="nav-g" class="stat-value">0.00</span>
                <span id="marge-g" class="stat-marge">--</span>
            </div>
            <div class="stat-group">
                <span class="stat-label">M-MOY</span>
                <span id="nav-m" class="stat-value">0.00%</span>
                <span id="marge-m" class="stat-marge">--</span>
            </div>
            <div class="stat-group">
                <span class="stat-label">D-MOY</span>
                <span id="nav-d" class="stat-value status-neutral">0.00%</span>
                <span id="marge-d" class="stat-marge">--</span>
            </div>
            <div class="stat-group border-l-2 border-blue-500 ml-4 px-2">
                <span class="stat-label" data-i18n="tonnage">TONNAGE</span>
                <span id="nav-t" class="stat-value text-blue-600">0.00 T</span>
                <span id="nav-s" class="stat-marge text-gray-400">0 SACS</span>
            </div>
        </div>

        <div class="flex gap-2 items-center">
            <button onclick="exportToPDF()" class="btn-theme" title="Exporter en PDF"><i class="fas fa-file-pdf"></i></button>
            <button onclick="toggleLang()" class="btn-lang" id="lang-btn">FR</button>
            <button onclick="toggleTheme()" class="btn-theme"><i id="theme-icon" class="fas fa-moon"></i></button>
            <button onclick="resoudreOptimisation()" class="btn-apple" data-i18n="btn-opti">Optimiser</button>
        </div>
    </nav>

    <main class="max-w-[1400px] mx-auto px-6 space-y-8">
        
        <div id="alert-bar" class="flex gap-4 overflow-x-auto pb-2"></div>

        <div class="card-apple p-8 flex flex-wrap lg:flex-nowrap items-center justify-between gap-6">
            <div class="flex gap-6 items-center">
                <div class="text-center"><p class="stat-label mb-2" data-i18n="target-bags">Sacs Cibles</p><input type="number" id="c-sacs" value="416" oninput="calculer()" class="text-3xl font-black w-24 outline-none bg-transparent"></div>
                <div class="text-center border-l border-gray-200 pl-6"><p class="stat-label mb-2" data-i18n="weight-bag">Poids/Sac</p><input type="number" id="c-kg" value="60.3" oninput="calculer()" class="text-3xl font-black w-24 outline-none text-blue-600 bg-transparent"></div>
            </div>
            <div class="grid grid-cols-4 gap-4 flex-1 max-w-2xl">
                <div><label class="stat-label">H-MAX %</label><input type="number" id="lim-h" value="7.5" oninput="calculer()" class="input-apple"></div>
                <div><label class="stat-label">G-MIN</label><input type="number" id="lim-g" value="110" oninput="calculer()" class="input-apple"></div>
                <div><label class="stat-label">M-MAX %</label><input type="number" id="lim-m" value="5.0" oninput="calculer()" class="input-apple"></div>
                <div><label class="stat-label text-orange-500">D-MAX %</label><input type="number" id="lim-d" value="1.5" oninput="calculer()" class="input-apple"></div>
            </div>
        </div>

        <div class="card-apple overflow-hidden">
            <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xs font-extrabold uppercase tracking-tighter text-gray-500" data-i18n="inv-title">Inventaire des Lots</h3>
                <button onclick="ajouterLot()" class="text-[10px] font-black uppercase text-blue-600" data-i18n="add-lot">+ Ajouter un lot</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[10px] font-bold text-gray-400 uppercase border-b border-gray-50">
                            <th class="px-8 py-4" data-i18n="th-id">Lot ID</th>
                            <th class="px-4 py-4 text-blue-600" data-i18n="th-pull">Sacs à tirer</th>
                            <th class="px-4 py-4" data-i18n="th-stock">Stock</th>
                            <th class="px-4 py-4" data-i18n="th-rem">Restant</th>
                            <th class="px-2 py-4 text-center">H%</th>
                            <th class="px-2 py-4 text-center">G</th>
                            <th class="px-2 py-4 text-center">M%</th>
                            <th class="px-2 py-4 text-center text-orange-500">D%</th>
                            <th class="px-8 py-4 text-right"></th>
                        </tr>
                    </thead>
                    <tbody id="lot-list" class="divide-y divide-gray-100 dark:divide-gray-800"></tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card-apple p-8 h-[400px]" id="radar-container">
                <h4 class="stat-label mb-6" data-i18n="chart-radar">Radar de Conformité</h4>
                <canvas id="radarChart"></canvas>
            </div>
            <div class="card-apple p-8 h-[400px]" id="pie-container">
                <h4 class="stat-label mb-6" data-i18n="chart-pie">Composition du Mix</h4>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="card-apple p-8 mb-20" id="excel-container">
            <h4 class="stat-label mb-6 text-blue-600 font-black"><i class="fas fa-file-excel mr-2"></i> <span data-i18n="excel-title">Vue Rapport Excel</span></h4>
            <div class="overflow-hidden rounded-xl border border-gray-200 dark:border-gray-800">
                <table class="w-full excel-table" id="excel-table-to-export">
                    <thead>
                        <tr>
                            <th data-i18n="th-id">ID Lot</th>
                            <th data-i18n="th-pull">Sacs Tirés</th>
                            <th data-i18n="th-weight">Poids (T)</th>
                            <th>H (%)</th>
                            <th data-i18n="th-grain">G (Grain)</th>
                            <th>M (%)</th>
                            <th>D (%)</th>
                        </tr>
                    </thead>
                    <tbody id="excel-view-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="pdf-export-content" style="display:none;"></div>

    <script>
        const i18n = {
            fr: {
                "app-title": "CACAO OPTIMIZER", "app-subtitle": "Moyennes en Temps Réel",
                "tonnage": "TONNAGE", "btn-opti": "Optimiser", "target-bags": "Sacs Cibles",
                "weight-bag": "Poids/Sac", "inv-title": "Inventaire des Lots", "add-lot": "+ Ajouter un lot",
                "th-id": "Lot ID", "th-pull": "Sacs à tirer", "th-stock": "Stock", "th-rem": "Restant",
                "chart-radar": "Radar de Conformité", "chart-pie": "Composition du Mix",
                "excel-title": "Vue Rapport Excel", "th-weight": "Poids (T)", "th-grain": "Grain"
            },
            en: {
                "app-title": "COCOA OPTIMIZER", "app-subtitle": "Real-Time Averages",
                "tonnage": "TONNAGE", "btn-opti": "Optimize", "target-bags": "Target Bags",
                "weight-bag": "Weight/Bag", "inv-title": "Batch Inventory", "add-lot": "+ Add Batch",
                "th-id": "Batch ID", "th-pull": "Bags to Pull", "th-stock": "Stock", "th-rem": "Remaining",
                "chart-radar": "Compliance Radar", "chart-pie": "Mix Composition",
                "excel-title": "Excel Report View", "th-weight": "Weight (T)", "th-grain": "Bean Count"
            }
        };

        let currentLang = 'fr';
        let radarChart, pieChart;
        let inventory = JSON.parse(localStorage.getItem('cacao_v5_solver')) || [
            { id: "LOT-01-SEC", pulled: 200, stock: 500, h: 6.8, g: 105, m: 2.0, d: 0.4 },
            { id: "LOT-05-HUM", pulled: 216, stock: 300, h: 8.5, g: 115, m: 5.5, d: 1.8 }
        ];

        function toggleLang() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            document.getElementById('lang-btn').innerText = currentLang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerText = i18n[currentLang][key];
            });
            updateCharts(); 
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('theme-icon');
            icon.className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
            updateCharts(); 
        }

        function save() { localStorage.setItem('cacao_v5_solver', JSON.stringify(inventory)); }

        function ajouterLot() {
            inventory.unshift({ id: "LOT-NEW", pulled: 0, stock: 1000, h: 7.5, g: 110, m: 3, d: 0.5 });
            render();
        }

        function render() {
            const list = document.getElementById('lot-list');
            list.innerHTML = '';
            inventory.forEach((l, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-8 py-3"><input type="text" value="${l.id}" oninput="updateData(${i},'id',this.value)" class="font-bold outline-none bg-transparent w-full"></td>
                    <td class="px-4 py-3"><input type="number" value="${l.pulled}" oninput="updateData(${i},'pulled',this.value)" class="input-apple text-blue-600"></td>
                    <td class="px-4 py-3"><input type="number" value="${l.stock}" oninput="updateData(${i},'stock',this.value)" class="input-apple"></td>
                    <td class="px-4 py-3 font-bold ${l.stock-l.pulled < 0 ? 'text-red-500' : 'text-gray-400'}">${l.stock-l.pulled}</td>
                    <td class="px-2 py-3"><input type="number" step="0.1" value="${l.h}" oninput="updateData(${i},'h',this.value)" class="input-apple"></td>
                    <td class="px-2 py-3"><input type="number" value="${l.g}" oninput="updateData(${i},'g',this.value)" class="input-apple"></td>
                    <td class="px-2 py-3"><input type="number" step="0.1" value="${l.m}" oninput="updateData(${i},'m',this.value)" class="input-apple"></td>
                    <td class="px-2 py-3"><input type="number" step="0.1" value="${l.d}" oninput="updateData(${i},'d',this.value)" class="input-apple"></td>
                    <td class="px-8 py-3 text-right"><button onclick="inventory.splice(${i},1);render();" class="text-red-400"><i class="fas fa-trash"></i></button></td>
                `;
                list.appendChild(tr);
            });
            calculer();
        }

        function updateData(i, field, val) {
            inventory[i][field] = field === 'id' ? val : parseFloat(val) || 0;
            save(); 
            if(field === 'stock' || field === 'pulled') render(); else calculer();
        }

        function calculer() {
            let sS = 0, sH = 0, sG = 0, sM = 0, sD = 0;
            const limits = {
                h: parseFloat(document.getElementById('lim-h').value),
                g: parseFloat(document.getElementById('lim-g').value),
                m: parseFloat(document.getElementById('lim-m').value),
                d: parseFloat(document.getElementById('lim-d').value),
                pkg: parseFloat(document.getElementById('c-kg').value)
            };

            const excelBody = document.getElementById('excel-view-body');
            excelBody.innerHTML = '';

            inventory.forEach(l => {
                sS += l.pulled; sH += l.pulled * l.h; sG += l.pulled * l.g; sM += l.pulled * l.m; sD += l.pulled * l.d;
                if(l.pulled > 0) {
                    excelBody.innerHTML += `<tr>
                        <td>${l.id}</td><td class="text-blue-600">${l.pulled}</td><td>${(l.pulled*limits.pkg/1000).toFixed(2)}T</td>
                        <td class="${l.h>limits.h?'text-red-500':''}">${l.h}</td><td>${l.g}</td><td>${l.m}</td><td>${l.d}</td>
                    </tr>`;
                }
            });

            const stats = {
                h: sS ? (sH/sS) : 0, g: sS ? (sG/sS) : 0, m: sS ? (sM/sS) : 0, d: sS ? (sD/sS) : 0
            };

            document.getElementById('nav-h').innerText = stats.h.toFixed(2) + "%";
            document.getElementById('nav-g').innerText = stats.g.toFixed(1);
            document.getElementById('nav-m').innerText = stats.m.toFixed(2) + "%";
            document.getElementById('nav-d').innerText = stats.d.toFixed(2) + "%";
            document.getElementById('nav-t').innerText = (sS * limits.pkg / 1000).toFixed(2) + " T";
            document.getElementById('nav-s').innerText = sS + " SACS";

            updateBadge('h', stats.h, limits.h, true);
            updateBadge('g', stats.g, limits.g, false);
            updateBadge('m', stats.m, limits.m, true);
            updateBadge('d', stats.d, limits.d, true);

            analyserStockGlobal(limits);
            updateCharts(stats.h, stats.g, stats.m, stats.d, limits.h, limits.g, limits.m, limits.d);
        }

        // --- FONCTIONNALITÉ 1 OPTIMISÉE (SOLVER MULTI-CRITÈRES) ---
        function resoudreOptimisation() {
            const target = parseInt(document.getElementById('c-sacs').value);
            const limH = parseFloat(document.getElementById('lim-h').value);
            
            // On réinitialise
            inventory.forEach(l => l.pulled = 0);
            
            // Stratégie : Utiliser d'abord les lots qui "corrigent" le plus les limites (les plus secs, gros grains)
            // On score chaque lot selon sa qualité globale
            let scoredInventory = [...inventory].map(l => {
                let score = (limH - l.h) * 10 + (l.g / 100); // Priorité forte à l'humidité
                return { ...l, score };
            }).sort((a, b) => b.score - a.score);

            let remaining = target;
            
            // Remplissage intelligent
            for (let lot of scoredInventory) {
                if (remaining <= 0) break;
                let take = Math.min(remaining, lot.stock);
                
                // Trouver l'index original pour mettre à jour l'objet réel
                let originalLot = inventory.find(orig => orig.id === lot.id);
                originalLot.pulled = take;
                remaining -= take;
            }
            
            render();
            alert(remaining > 0 ? `Attention: Stock insuffisant pour atteindre ${target} sacs.` : "Optimisation terminée avec succès !");
        }

        // --- FONCTIONNALITÉ 5 (ALERTES PRÉDICTIVES) ---
        function analyserStockGlobal(limits) {
            const alertBar = document.getElementById('alert-bar');
            alertBar.innerHTML = '';
            
            let totalStockSacs = 0, sumH = 0, sumG = 0;
            inventory.forEach(l => {
                let r = l.stock - l.pulled;
                totalStockSacs += r;
                sumH += r * l.h;
                sumG += r * l.g;
            });

            const avgH = totalStockSacs ? (sumH / totalStockSacs) : 0;
            const avgG = totalStockSacs ? (sumG / totalStockSacs) : 0;

            // Alerte Humidité Stock
            if (avgH > limits.h - 0.2) {
                addAlert('danger', `Danger Humidité: Stock résiduel trop humide (${avgH.toFixed(2)}%)`);
            } else if (avgH > limits.h - 0.5) {
                addAlert('warning', `Vigilance Humidité: Stock résiduel limite (${avgH.toFixed(2)}%)`);
            } else {
                addAlert('ok', `Stock Humidité Sain (${avgH.toFixed(2)}%)`);
            }

            // Alerte Quantité
            if (totalStockSacs < parseInt(document.getElementById('c-sacs').value) * 2) {
                addAlert('danger', `Stock Critique: Moins de 2 tirages disponibles.`);
            }
        }

        function addAlert(type, msg) {
            const div = document.createElement('div');
            div.className = `alert-pill alert-${type}`;
            const icon = type === 'ok' ? 'check-circle' : 'exclamation-triangle';
            div.innerHTML = `<i class="fas fa-${icon}"></i> ${msg}`;
            document.getElementById('alert-bar').appendChild(div);
        }

        function updateBadge(id, val, lim, isMax) {
            const el = document.getElementById(`marge-${id}`);
            const diff = lim - val;
            const ok = isMax ? diff >= 0 : diff <= 0;
            el.innerText = (ok ? '+' : '') + diff.toFixed(2);
            el.className = `stat-marge ${ok ? 'status-positive' : 'status-negative animate-pulse'}`;
        }

        function updateCharts(ah, ag, am, ad, lh, lg, lm, ld) {
            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
            const textColor = isDark ? '#a1a1a6' : '#86868b';

            const ctxR = document.getElementById('radarChart').getContext('2d');
            if(radarChart) radarChart.destroy();
            radarChart = new Chart(ctxR, {
                type: 'radar',
                data: {
                    labels: ['H%', 'G/20', 'M%', 'D%'],
                    datasets: [
                        { label: 'Mix Actuel', data: [ah, ag/20, am, ad], borderColor: '#0071e3', backgroundColor: 'rgba(0,113,227,0.2)' },
                        { label: 'Limites', data: [lh, lg/20, lm, ld], borderColor: '#ef4444', borderDash: [5,5], fill: false }
                    ]
                },
                options: { maintainAspectRatio: false, scales: { r: { grid: { color: gridColor }, pointLabels: { color: textColor } } } }
            });

            const active = inventory.filter(l => l.pulled > 0);
            const ctxP = document.getElementById('pieChart').getContext('2d');
            if(pieChart) pieChart.destroy();
            pieChart = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: active.map(l => l.id),
                    datasets: [{ data: active.map(l => l.pulled), backgroundColor: ['#0071e3', '#34c759', '#ff9500', '#af52de', '#5856d6', '#ff2d55'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } } } }
            });
        }

        function exportToPDF() {
            const content = document.getElementById('pdf-export-content');
            content.style.display = 'block';
            content.innerHTML = `
                <div style="padding: 20px;">
                    <h1 style="text-align:center; color:#0071e3;">RAPPORT QUALITÉ CACAO</h1>
                    <p style="text-align:center;">Généré le ${new Date().toLocaleString()}</p>
                    <div style="margin: 20px 0;">${document.getElementById('excel-container').innerHTML}</div>
                    <img src="${radarChart.toBase64Image()}" style="width:45%; display:inline-block;">
                    <img src="${pieChart.toBase64Image()}" style="width:45%; display:inline-block;">
                </div>
            `;
            html2pdf().from(content).save('Rapport_Cacao.pdf').then(() => content.style.display = 'none');
        }

        window.onload = render;
    </script>
</body>
</html>
